<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Qu·∫£n L√Ω H√¨nh Th·ª©c Thi</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <style>
            .interface-container {
                background-color: #f0f0f0;
                padding: 20px;
                font-family: Arial, sans-serif;
            }
            .top-section {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            .action-buttons {
                position: relative;
            }
            .action-buttons button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 5px 10px;
                margin-left: 10px;
                cursor: pointer;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
            }
            th,
            td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
                box-sizing: border-box;
            }
            th {
                background-color: #333f50;
                color: white;
                cursor: pointer;
                text-align: center;
            }
            tbody tr:nth-child(odd) {
                background-color: #f5f5f5;
            }
            tbody tr:nth-child(even) {
                background-color: #ffffff;
            }
            .action-cell {
                display: flex;
                justify-content: space-around;
            }
            .add-new-form {
                margin-top: 10px;
                display: flex;
                align-items: center;
            }
            .add-new-form input {
                padding: 5px;
                margin-right: 10px;
                background-color: #ffffe0;
                border: 1px solid #ddd;
                box-sizing: border-box;
            }
            .add-new-form button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 5px 10px;
                cursor: pointer;
            }
            button:hover {
                opacity: 0.8;
            }
            .delete-icon:hover {
                color: red;
            }
            /* ƒê·ªãnh k√≠ch th∆∞·ªõc c·ªôt */
            th:nth-child(1),
            td:nth-child(1) {
                width: 10%;
            }
            th:nth-child(2),
            td:nth-child(2) {
                width: 30%;
            }
            th:nth-child(3),
            td:nth-child(3) {
                width: 10%;
            }
            th:nth-child(4),
            td:nth-child(4) {
                width: 15%;
            }
            th:nth-child(5),
            td:nth-child(5) {
                width: 20%;
            }
            th:nth-child(6),
            td:nth-child(6) {
                width: 15%;
            }
            /* ƒê·ªãnh k√≠ch th∆∞·ªõc textbox */
            input[name="name"],
            input[name="filter-name"] {
                width: 100%;
                max-width: calc(10% - 18px);
            }
            input[name="title"],
            input[name="filter-title"] {
                width: 100%;
                max-width: calc(30% - 18px);
            }
            input[name="priority"],
            input[name="filter-priority"] {
                width: 100%;
                max-width: calc(10% - 18px);
            }
            input[name="filter-last_modified_by"] {
                width: 100%;
                max-width: calc(15% - 18px);
            }
            input[name="filter-last_modified_date"] {
                width: 100%;
                max-width: calc(20% - 18px);
            }
            /* Dropdown v√† Form l·ªçc */
            .sort-options,
            .filter-form {
                display: none;
                position: absolute;
                background-color: white;
                border: 1px solid #ddd;
                padding: 15px;
                z-index: 1;
            }
            .sort-options select {
                margin-right: 10px;
            }
            .filter-form {
                width: 400px;
            }
            .filter-form input {
                margin-bottom: 10px;
                padding: 8px;
                display: block;
                width: 100%;
                box-sizing: border-box;
            }
            .filter-form button {
                margin-right: 10px;
                padding: 5px 10px;
            }
            /* S·ª≠ d·ª•ng CSS ƒë·ªÉ hi·ªÉn th·ªã/·∫©n dropdown v√† form l·ªçc */
            .action-buttons:hover .sort-options,
            .action-buttons:hover .filter-form {
                display: block;
            }
        </style>
    </head>
    <body>
        <div class="interface-container">
            <!-- Ph·∫ßn tr√™n b·∫£ng -->
            <div class="top-section">
                <div></div>
                <div class="action-buttons">
                    <button id="filter-btn">L·ªçc üîç</button>
                    <button id="sort-btn">S·∫Øp x·∫øp ‚Üì</button>
                    <div id="sort-options" class="sort-options">
                        <select id="sort-column">
                            <option value="name">Vi·ªát T·∫Øt</option>
                            <option value="title">T√™n Nh√≥m</option>
                            <option value="priority">∆Øu Ti√™n</option>
                            <option value="last_modified_date">Ng√†y S·ª≠a</option>
                        </select>
                        <select id="sort-order">
                            <option value="asc">TƒÉng d·∫ßn</option>
                            <option value="desc">Gi·∫£m d·∫ßn</option>
                        </select>
                        <button id="apply-sort">√Åp d·ª•ng</button>
                    </div>
                    <div id="filter-form" class="filter-form">
                        <input
                            type="text"
                            name="filter-name"
                            placeholder="Vi·ªát T·∫Øt"
                        />
                        <input
                            type="text"
                            name="filter-title"
                            placeholder="T√™n Nh√≥m"
                        />
                        <input
                            type="number"
                            name="filter-priority"
                            placeholder="∆Øu Ti√™n"
                        />
                        <input
                            type="text"
                            name="filter-last_modified_by"
                            placeholder="Ng∆∞·ªùi S·ª≠a"
                        />
                        <input
                            type="text"
                            name="filter-last_modified_date"
                            placeholder="Ng√†y S·ª≠a"
                        />
                        <button id="apply-filter">L·ªçc</button>
                        <button id="clear-filter">X√≥a b·ªô l·ªçc</button>
                    </div>
                </div>
            </div>

            <!-- B·∫£ng d·ªØ li·ªáu -->
            <table id="exam-types-table">
                <thead>
                    <tr>
                        <th data-sort="name">Vi·ªát T·∫Øt</th>
                        <th data-sort="title">T√™n Nh√≥m</th>
                        <th data-sort="priority">∆Øu Ti√™n</th>
                        <th>Ng∆∞·ªùi S·ª≠a</th>
                        <th data-sort="last_modified_date">Ng√†y S·ª≠a</th>
                        <th>Thao T√°c</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                </tbody>
            </table>

            <!-- D√≤ng nh·∫≠p li·ªáu -->
            <div class="add-new-form">
                <input
                    type="text"
                    id="new-name"
                    name="name"
                    placeholder="Vi·ªát T·∫Øt"
                />
                <input
                    type="text"
                    id="new-title"
                    name="title"
                    placeholder="T√™n Nh√≥m"
                />
                <input
                    type="number"
                    id="new-priority"
                    name="priority"
                    placeholder="∆Øu Ti√™n"
                />
                <button id="add-btn">Th√™m m·ªõi</button>
            </div>
        </div>
        <script>
            let currentSort = "id",
                currentOrder = "asc",
                currentEditingRow = null;
            let allData = [],
                filterApplied = false;

            // T·∫£i d·ªØ li·ªáu t·ª´ server
            function loadAllExamTypes() {
                $.get(
                    "/get_exam_types",
                    { sort: currentSort, order: currentOrder },
                    (data) => {
                        allData = data;
                        applyFilters();
                    }
                );
            }

            // √Åp d·ª•ng b·ªô l·ªçc v√† hi·ªÉn th·ªã d·ªØ li·ªáu
            function applyFilters() {
                let data = filterApplied
                    ? allData.filter(
                          (entry) =>
                              (!$('input[name="filter-name"]').val() ||
                                  entry.name
                                      .toLowerCase()
                                      .includes(
                                          $('input[name="filter-name"]')
                                              .val()
                                              .toLowerCase()
                                      )) &&
                              (!$('input[name="filter-title"]').val() ||
                                  entry.title
                                      .toLowerCase()
                                      .includes(
                                          $('input[name="filter-title"]')
                                              .val()
                                              .toLowerCase()
                                      )) &&
                              (!$('input[name="filter-priority"]').val() ||
                                  entry.priority ==
                                      $(
                                          'input[name="filter-priority"]'
                                      ).val()) &&
                              (!$(
                                  'input[name="filter-last_modified_by"]'
                              ).val() ||
                                  entry.last_modified_by
                                      .toLowerCase()
                                      .includes(
                                          $(
                                              'input[name="filter-last_modified_by"]'
                                          )
                                              .val()
                                              .toLowerCase()
                                      )) &&
                              (!$(
                                  'input[name="filter-last_modified_date"]'
                              ).val() ||
                                  entry.last_modified_date.includes(
                                      $(
                                          'input[name="filter-last_modified_date"]'
                                      ).val()
                                  ))
                      )
                    : allData;
                renderTable(data);
            }

            // Hi·ªÉn th·ªã d·ªØ li·ªáu l√™n b·∫£ng
            function renderTable(data) {
                $("#exam-types-table tbody").empty();
                data.forEach((entry) => {
                    let row = $("<tr>").attr("data-id", entry.id);
                    row.append($("<td>").text(entry.name));
                    row.append($("<td>").text(entry.title));
                    row.append($("<td>").text(entry.priority));
                    row.append($("<td>").text(entry.last_modified_by));
                    row.append($("<td>").text(entry.last_modified_date));
                    row.append(
                        $('<td class="action-cell">').append(
                            '<span class="edit-icon">‚úèÔ∏è</span><span class="delete-icon">X</span>'
                        )
                    );
                    $("#exam-types-table tbody").append(row);
                });
            }

            // X·ª≠ l√Ω c√°c s·ª± ki·ªán
            $(document).ready(() => {
                loadAllExamTypes();

                // S·∫Øp x·∫øp khi click v√†o ti√™u ƒë·ªÅ c·ªôt
                $("#exam-types-table thead th").click(function () {
                    let sort = $(this).data("sort");
                    if (sort) {
                        currentSort = sort;
                        currentOrder =
                            sort === currentSort && currentOrder === "asc"
                                ? "desc"
                                : "asc";
                        loadAllExamTypes();
                    }
                });

                // Th√™m m·ªõi
                $("#add-btn").click(() => {
                    let name = $("#new-name").val(),
                        title = $("#new-title").val(),
                        priority = $("#new-priority").val();
                    if (name && title && priority) {
                        $.post(
                            "/add_exam_type",
                            { name, title, priority },
                            (data) => {
                                allData.push(data);
                                applyFilters();
                                $("#new-name, #new-title, #new-priority").val(
                                    ""
                                );
                            }
                        );
                    } else {
                        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c √¥!");
                    }
                });

                // Ch·ªânh s·ª≠a v√† x√≥a
                $(document).on("click", ".edit-icon", function () {
                    if (currentEditingRow) cancelEdit();
                    currentEditingRow = $(this).closest("tr");
                    currentEditingRow
                        .find("td:not(:last)")
                        .slice(0, 3)
                        .each(function (i) {
                            $(this)
                                .data("original", $(this).text())
                                .html(
                                    i === 2
                                        ? `<input name="${
                                              ["name", "title", "priority"][i]
                                          }" type="number" value="${$(
                                              this
                                          ).text()}">`
                                        : `<input name="${
                                              ["name", "title", "priority"][i]
                                          }" value="${$(this).text()}">`
                                );
                        });
                    currentEditingRow
                        .find(".action-cell")
                        .html(
                            '<button class="update-btn">Update</button><button class="cancel-btn">Cancel</button>'
                        );
                });

                $(document).on("click", ".update-btn", function () {
                    let row = $(this).closest("tr"),
                        id = row.data("id");
                    let name = row.find("td:eq(0) input").val(),
                        title = row.find("td:eq(1) input").val(),
                        priority = row.find("td:eq(2) input").val();
                    if (name && title && priority) {
                        $.post(
                            "/update_exam_type",
                            { id, name, title, priority },
                            (data) => {
                                allData[
                                    allData.findIndex((item) => item.id == id)
                                ] = data;
                                applyFilters();
                                currentEditingRow = null;
                            }
                        );
                    } else {
                        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c √¥!");
                    }
                });

                $(document).on("click", ".cancel-btn", () => cancelEdit());

                $(document).on("click", ".delete-icon", function () {
                    if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d√≤ng n√†y kh√¥ng?")) {
                        let id = $(this).closest("tr").data("id");
                        $.post("/delete_exam_type", { id }, () => {
                            allData = allData.filter((item) => item.id != id);
                            applyFilters();
                        });
                    }
                });

                // S·∫Øp x·∫øp v√† l·ªçc
                $("#apply-sort").click(() => {
                    currentSort = $("#sort-column").val();
                    currentOrder = $("#sort-order").val();
                    loadAllExamTypes();
                });

                $("#apply-filter").click(() => {
                    filterApplied = true;
                    applyFilters();
                });

                $("#clear-filter").click(() => {
                    filterApplied = false;
                    $("#filter-form input").val("");
                    applyFilters();
                });
            });

            function cancelEdit() {
                if (currentEditingRow) {
                    currentEditingRow
                        .find("td:not(:last)")
                        .slice(0, 3)
                        .each(function () {
                            $(this).text($(this).data("original"));
                        });
                    currentEditingRow
                        .find(".action-cell")
                        .html(
                            '<span class="edit-icon">‚úèÔ∏è</span><span class="delete-icon">X</span>'
                        );
                    currentEditingRow = null;
                }
            }
        </script>
    </body>
</html>
